# ============================================================
# Loan-MoE System - Docker Compose Configuration
# For WSL2 + NVIDIA GPU Environment
# ============================================================

version: '3.8'

services:
  # ========================================
  # Main Application
  # ========================================
  loan-moe:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: loan-moe-app
    restart: unless-stopped
    
    # GPU Support for WSL2
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1  # Use 1 GPU, change to 'all' for multiple GPUs
              capabilities: [gpu]
    
    # Environment variables
    env_file:
      - .env
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    
    # Volume mounts
    volumes:
      # Model weights (persistent)
      - ./models:/app/models:ro
      - ./moe/models:/app/moe/models:ro
      
      # Hugging Face cache (persistent)
      - hf_cache:/app/.cache/huggingface
      
      # Logs
      - ./logs:/app/logs
      
      # For development: mount source code
      # - .:/app
    
    # Network
    networks:
      - loan-moe-network
    
    # Dependencies
    depends_on:
      redis:
        condition: service_healthy
    
    # Port mapping (for future API)
    ports:
      - "8000:8000"
    
    # Interactive mode
    stdin_open: true
    tty: true
    
    # Command - 啟動 API Server (預設)
    # 若要使用互動模式，執行: docker compose exec loan-moe python main.py
    command: uvicorn api:app --host 0.0.0.0 --port 8000
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ========================================
  # Redis - Session Management
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: loan-moe-redis
    restart: unless-stopped
    
    # Persist data
    volumes:
      - redis_data:/data
    
    # Custom configuration
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Network
    networks:
      - loan-moe-network
    
    # Port mapping (for debugging)
    ports:
      - "6379:6379"

  # ========================================
  # Redis Commander - Web UI (Optional)
  # ========================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: loan-moe-redis-ui
    restart: unless-stopped
    
    environment:
      - REDIS_HOSTS=local:redis:6379
    
    ports:
      - "8081:8081"
    
    networks:
      - loan-moe-network
    
    depends_on:
      - redis
    
    profiles:
      - debug  # Only start with: docker compose --profile debug up

  # ========================================
  # Jupyter Notebook (Development)
  # ========================================
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: loan-moe-jupyter
    restart: unless-stopped
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    env_file:
      - .env
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - REDIS_HOST=redis
    
    volumes:
      - .:/app
      - hf_cache:/app/.cache/huggingface
      - jupyter_data:/root/.jupyter
    
    ports:
      - "8888:8888"
    
    networks:
      - loan-moe-network
    
    depends_on:
      - redis
    
    command: jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token=''
    
    profiles:
      - dev  # Only start with: docker compose --profile dev up

  # ========================================
  # Testing Service
  # ========================================
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: loan-moe-test
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    env_file:
      - .env
    environment:
      - REDIS_HOST=redis
      - ENABLE_FINETUNED_MODELS=False  # Faster testing without models
    
    volumes:
      - .:/app
      - hf_cache:/app/.cache/huggingface
    
    networks:
      - loan-moe-network
    
    depends_on:
      redis:
        condition: service_healthy
    
    command: python run_tests.py
    
    profiles:
      - test  # Only start with: docker compose --profile test up

# ========================================
# Networks
# ========================================
networks:
  loan-moe-network:
    driver: bridge
    name: loan-moe-network

# ========================================
# Volumes
# ========================================
volumes:
  redis_data:
    name: loan-moe-redis-data
  hf_cache:
    name: loan-moe-hf-cache
  jupyter_data:
    name: loan-moe-jupyter-data
